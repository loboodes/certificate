<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†Ø´Ø¦ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù… - GitHub Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary: #195d48;
            --secondary: #d4af37;
            --bg-light: #f4f6f9;
            --text: #333;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--bg-light);
            color: var(--text);
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        /* --- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© --- */
        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            height: fit-content;
        }

        .sidebar h2 { font-size: 1.2rem; margin-bottom: 15px; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
        }
        
        /* Ø´Ø¨ÙƒØ© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ù„ÙÙŠØ§Øª */
        .bg-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        .bg-option {
            aspect-ratio: 1.41; /* A4 Ratio */
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            transition: all 0.2s;
        }
        .bg-option:hover { border-color: var(--primary); }
        .bg-option.selected { border-color: var(--secondary); box-shadow: 0 0 0 2px var(--secondary); }

        /* Ù…Ù†Ø·Ù‚Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù */
        .upload-area {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: 0.3s;
        }
        .upload-area:hover { border-color: var(--primary); background: #f0fdf4; }

        /* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© --- */
        .preview-area {
            background: #ccc;
            border-radius: 12px;
            padding: 40px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            overflow: auto;
            min-height: 80vh;
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© (A4 Landscape) */
        .certificate-container {
            width: 1123px; /* A4 width at 96 DPI approx */
            height: 794px; /* A4 height */
            background-color: white;
            background-size: 100% 100%;
            background-repeat: no-repeat;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform-origin: top center;
            transition: transform 0.2s;
        }

        /* Ù†ØµÙˆØµ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© */
        .cert-content {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding-top: 240px; /* Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„ØªØ¬Ø§ÙˆØ² ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„ØªØµÙ…ÙŠÙ… */
        }

        .cert-intro { font-size: 24px; margin-bottom: 10px; color: #444; }
        .cert-name { 
            font-family: 'Amiri', serif; 
            font-size: 55px; 
            font-weight: bold; 
            color: var(--primary); 
            margin: 15px 0;
            line-height: 1.2;
        }
        .cert-body { 
            font-size: 26px; 
            width: 80%; 
            line-height: 1.6; 
            color: #333; 
            margin-bottom: 40px;
        }
        
        .footer-section {
            position: absolute;
            bottom: 60px;
            width: 100%;
            display: flex;
            justify-content: space-around;
            padding: 0 100px;
        }

        .signature { text-align: center; }
        .sig-title { font-weight: bold; font-size: 24px; color: #555; margin-bottom: 10px; }
        .sig-name { font-size: 28px; font-weight: bold; color: var(--primary); font-family: 'Amiri', serif; }

        .btn-action {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 10px;
        }
        .btn-action:disabled { background: #ccc; cursor: not-allowed; }
        .btn-action:hover:not(:disabled) { background: #144a39; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
        .progress-box { display: none; margin-top: 15px; }
        .progress-bar { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--secondary); width: 0%; transition: width 0.3s; }
        .status-text { font-size: 0.9rem; text-align: center; margin-top: 5px; }

        @media (max-width: 1200px) {
            .container { grid-template-columns: 1fr; }
            .certificate-container { transform: scale(0.6); margin-bottom: -300px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <h2>1. Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (Excel)</h2>
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <p>ğŸ“‚ Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ù…Ù„Ù Excel</p>
            <input type="file" id="fileInput" accept=".xlsx,.xls" hidden>
        </div>
        <div id="fileInfo" style="font-size: 0.9rem; color: green; display: none; margin-bottom: 10px;"></div>

        <h2>2. Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ…ÙŠÙ…</h2>
        <div class="bg-grid" id="bgGrid">
            </div>

        <h2>3. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</h2>
        <div class="form-group">
            <label>Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© (Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø§Ù†Ø­Ø©)</label>
            <input type="text" id="inIntro" value="ÙŠØ³Ø± Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯Ø±Ø³Ø© ØªØ­ÙÙŠØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø¨Ø§Ù„Ø¨Ø¬Ø§Ø¯ÙŠØ©" class="live-update">
        </div>
        <div class="form-group">
            <label>Ù†Øµ Ø§Ù„Ø´ÙƒØ± ÙˆØ§Ù„Ø³Ø¨Ø¨</label>
            <textarea id="inBody" rows="3" class="live-update">Ø£Ù† ØªØªÙ‚Ø¯Ù… Ø¨ÙˆØ§ÙØ± Ø§Ù„Ø´ÙƒØ± ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ± Ù„ØªÙÙˆÙ‚Ù‡ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ø®Ù„Ø§Ù„ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø£ÙˆÙ„ Ù„Ø¹Ø§Ù… Ù¡Ù¤Ù¤Ù§ Ù‡Ù€</textarea>
        </div>
        <div class="form-group">
            <label>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ù„Ù„Ù…ÙˆÙ‚Ø¹</label>
            <input type="text" id="inSigTitle" value="Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©" class="live-update">
        </div>
        <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø§Ù„Ù…Ø¯ÙŠØ±/Ø§Ù„Ù…Ø¹Ù„Ù…)</label>
            <input type="text" id="inManager" value="Ø£. Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡" class="live-update">
        </div>

        <h2>4. Ø§Ù„ØªØµØ¯ÙŠØ±</h2>
        <div class="form-group">
            <label>Ø¹Ù…ÙˆØ¯ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ (Ù…Ù† Ù…Ù„Ù Excel)</label>
            <select id="colSelect"><option>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹</option></select>
        </div>
        <button id="btnGenerate" class="btn-action" onclick="generateAllPDFs()" disabled>ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª (PDF)</button>

        <div class="progress-box" id="progressBox">
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
            <div class="status-text" id="statusText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²...</div>
        </div>
    </div>

    <div class="preview-area">
        <div class="certificate-container" id="certPreview">
            <div class="cert-content">
                <div class="cert-intro" id="outIntro">ÙŠØ³Ø± Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯Ø±Ø³Ø©...</div>
                <div class="cert-intro" style="margin-top:5px; font-size: 20px;">Ø£Ù† ØªÙ…Ù†Ø­ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù„Ù„Ø·Ø§Ù„Ø¨/Ù€Ø©:</div>
                <div class="cert-name" id="outName">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ù‡Ù†Ø§</div>
                <div class="cert-body" id="outBody">Ù†Øµ Ø§Ù„Ø´ÙƒØ± ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ± Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§...</div>
            </div>
            
            <div class="footer-section">
                <div class="signature">
                    <div class="sig-title">Ø§Ù„Ø®ØªÙ…</div>
                    <div style="width: 120px; height: 120px; border: 2px dashed #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #ccc;">Ù…ÙƒØ§Ù† Ø§Ù„Ø®ØªÙ…</div>
                </div>
                <div class="signature">
                    <div class="sig-title" id="outSigTitle">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>
                    <div class="sig-name" id="outManager">Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="hidden-container" style="position: absolute; left: -9999px; top: 0;"></div>

<script>
    let excelData = [];
    let selectedBg = 'bg1.png'; // Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©

    // 1. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ØµØºØ±Ø©
    const bgGrid = document.getElementById('bgGrid');
    for (let i = 1; i <= 12; i++) {
        const div = document.createElement('div');
        div.className = `bg-option ${i === 1 ? 'selected' : ''}`;
        const imgName = `bg${i}.png`;
        div.style.backgroundImage = `url('${imgName}')`;
        div.onclick = () => selectBackground(div, imgName);
        bgGrid.appendChild(div);
    }

    function selectBackground(el, imgName) {
        document.querySelectorAll('.bg-option').forEach(d => d.classList.remove('selected'));
        el.classList.add('selected');
        selectedBg = imgName;
        document.getElementById('certPreview').style.backgroundImage = `url('${imgName}')`;
    }

    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    document.getElementById('certPreview').style.backgroundImage = `url('${selectedBg}')`;

    // 2. Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ù†ØµÙˆØµ (Live Update)
    const inputs = document.querySelectorAll('.live-update');
    inputs.forEach(input => {
        input.addEventListener('input', updatePreview);
    });

    function updatePreview() {
        document.getElementById('outIntro').textContent = document.getElementById('inIntro').value;
        document.getElementById('outBody').textContent = document.getElementById('inBody').value;
        document.getElementById('outSigTitle').textContent = document.getElementById('inSigTitle').value;
        document.getElementById('outManager').textContent = document.getElementById('inManager').value;
    }

    // 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Excel
    document.getElementById('fileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            if (json.length < 2) {
                alert("Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©");
                return;
            }

            // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø¤ÙˆØ³
            const headers = json[0];
            excelData = json.slice(1); // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø±Ø£Ø³

            // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
            const colSelect = document.getElementById('colSelect');
            colSelect.innerHTML = '';
            headers.forEach((h, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = h || `Ø¹Ù…ÙˆØ¯ ${i+1}`;
                if (h && h.includes('Ø§Ø³Ù…')) opt.selected = true; // Ø§Ø®ØªÙŠØ§Ø± Ø°ÙƒÙŠ
                colSelect.appendChild(opt);
            });

            document.getElementById('fileInfo').textContent = `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${excelData.length} Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­ âœ…`;
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('btnGenerate').disabled = false;
        };
        reader.readAsArrayBuffer(file);
    });

    // 4. ØªÙˆÙ„ÙŠØ¯ Ù…Ù„ÙØ§Øª PDF (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£Ù‡Ù…)
    async function generateAllPDFs() {
        const { jsPDF } = window.jspdf;
        const btn = document.getElementById('btnGenerate');
        const progressBox = document.getElementById('progressBox');
        const progressFill = document.getElementById('progressFill');
        const statusText = document.getElementById('statusText');
        const hiddenContainer = document.getElementById('hidden-container');
        const nameColIndex = document.getElementById('colSelect').value;

        // Ù‚ÙÙ„ Ø§Ù„Ø²Ø±
        btn.disabled = true;
        progressBox.style.display = 'block';

        // Ù†Ø³Ø® Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù…Ø®ÙÙŠØ© Ù„Ù„Ø±ÙŠÙ†Ø¯Ø±
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†Ø³ØªØ®Ø¯Ù… Ù†Ø³Ø®Ø© Ø·Ø¨Ù‚ Ø§Ù„Ø£ØµÙ„ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
        const templateHTML = document.getElementById('certPreview').outerHTML;

        for (let i = 0; i < excelData.length; i++) {
            const row = excelData[i];
            const studentName = row[nameColIndex];

            if (!studentName) continue;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            const percent = Math.round(((i + 1) / excelData.length) * 100);
            progressFill.style.width = `${percent}%`;
            statusText.textContent = `Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ù‡Ø§Ø¯Ø©: ${studentName} (${i+1}/${excelData.length})`;

            // ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù…Ø®ÙÙŠØ© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù…
            hiddenContainer.innerHTML = templateHTML;
            const hiddenCert = hiddenContainer.querySelector('.certificate-container');
            hiddenCert.id = "temp-cert"; // ØªØºÙŠÙŠØ± Ø§Ù„Ù€ ID Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¹Ø§Ø±Ø¶
            hiddenCert.style.transform = "none"; // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØµØºÙŠØ±
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø®ÙÙŠØ©
            hiddenCert.querySelector('#outName').textContent = studentName;
            // ÙŠÙ…ÙƒÙ† Ù‡Ù†Ø§ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ "Ø§Ù„Ø³Ø¨Ø¨" Ù…Ù† Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ø¥Ø°Ø§ ÙˆØ¬Ø¯ Ø¹Ù…ÙˆØ¯ Ù…Ø®ØµØµ

            // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„ØµÙˆØ± Ø§Ù„Ù…Ø­Ù„ÙŠØ©)
            await new Promise(resolve => setTimeout(resolve, 50));

            // ØªØ­ÙˆÙŠÙ„ HTML Ø¥Ù„Ù‰ Canvas
            const canvas = await html2canvas(hiddenCert, {
                scale: 2, // Ø¯Ù‚Ø© Ø£Ø¹Ù„Ù‰
                useCORS: true,
                allowTaint: true
            });

            // ØªØ­ÙˆÙŠÙ„ Canvas Ø¥Ù„Ù‰ PDF
            const pdf = new jsPDF('l', 'mm', 'a4'); // Landscape A4
            const imgData = canvas.toDataURL('image/jpeg', 0.9);
            pdf.addImage(imgData, 'JPEG', 0, 0, 297, 210);
            
            // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
            pdf.save(`Ø´Ù‡Ø§Ø¯Ø©_${studentName.replace(/\s/g, '_')}.pdf`);
        }

        // Ø¥Ù†Ù‡Ø§Ø¡
        statusText.textContent = "âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª!";
        btn.disabled = false;
        setTimeout(() => {
             progressBox.style.display = 'none';
             hiddenContainer.innerHTML = '';
        }, 3000);
    }
</script>

</body>
</html>
